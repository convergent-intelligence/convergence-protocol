<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Convergent Intelligence</title>
    <link rel="stylesheet" href="styles/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
    <div id="header-placeholder"></div>

    <main class="container">
        <div class="page-header">
            <h1>Protocol Dashboard</h1>
            <p>Monitor tokens, track burns, and manage your participation in the Convergence Protocol</p>
        </div>

        <!-- Wallet Connection Status -->
        <div class="content-card" style="margin-bottom: 2rem;">
            <div id="walletStatus">
                <p style="text-align: center; color: var(--text);">
                    <span id="connectionStatus">Not connected</span>
                    <button class="cta-button primary" id="connectWalletBtn" style="margin-left: 1rem;">Connect Wallet</button>
                </p>
            </div>
        </div>

        <!-- Token Balances -->
        <div class="section">
            <h2 style="text-align: center; margin-bottom: 2rem;">Your Token Balances</h2>
            <div class="token-container">
                <div class="token-card">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ü™ô</div>
                    <h3>TALLY</h3>
                    <p class="balance" id="tallyBalance">--</p>
                    <p style="font-size: 0.875rem; color: var(--text); margin-top: 0.5rem;">Reserve-backed token</p>
                </div>

                <div class="token-card">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üíé</div>
                    <h3>TRUST</h3>
                    <p class="balance" id="trustBalance">--</p>
                    <p style="font-size: 0.875rem; color: var(--text); margin-top: 0.5rem;">Earned by burning TALLY</p>
                </div>

                <div class="token-card">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìú</div>
                    <h3>Covenant NFT</h3>
                    <p class="balance" id="covenantStatus">--</p>
                    <p style="font-size: 0.875rem; color: var(--text); margin-top: 0.5rem;">Soulbound governance token</p>
                </div>
            </div>
        </div>

        <!-- Global Statistics -->
        <div class="section">
            <h2 style="text-align: center; margin-bottom: 2rem;">Global Protocol Statistics</h2>

            <div class="content-card" style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1.5rem;">TALLY Burn Tracking</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                    <div>
                        <div style="font-size: 0.875rem; color: var(--text); margin-bottom: 0.5rem;">Total TALLY Burned</div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: var(--primary);" id="totalBurned">--</div>
                    </div>
                    <div>
                        <div style="font-size: 0.875rem; color: var(--text); margin-bottom: 0.5rem;">Total TRUST Minted</div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: var(--success);" id="totalTrustMinted">--</div>
                    </div>
                    <div>
                        <div style="font-size: 0.875rem; color: var(--text); margin-bottom: 0.5rem;">Burn Rate</div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: var(--accent);" id="burnRate">1:1</div>
                    </div>
                    <div>
                        <div style="font-size: 0.875rem; color: var(--text); margin-bottom: 0.5rem;">Total Reserve Value</div>
                        <div style="font-size: 1.75rem; font-weight: 700; color: var(--warning);" id="reserveValue">$620.08</div>
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <div style="font-size: 0.875rem; color: var(--text); margin-bottom: 0.5rem;">Global Unlock Progress</div>
                    <div class="progress-bar-container" style="height: 12px;">
                        <div class="progress-bar-fill" id="globalUnlockProgress" style="width: 0%"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text);">
                        <span>0 TALLY</span>
                        <span id="unlockGoal">Goal: 1000 TALLY</span>
                    </div>
                </div>
            </div>

            <div class="features-grid">
                <div class="feature-card">
                    <span class="feature-icon">üë•</span>
                    <h3>Total Adopters</h3>
                    <p style="font-size: 2rem; font-weight: 700; color: var(--primary);" id="totalAdopters">--</p>
                </div>

                <div class="feature-card">
                    <span class="feature-icon">üî•</span>
                    <h3>Unlock Events</h3>
                    <p style="font-size: 2rem; font-weight: 700; color: var(--secondary);" id="unlockEvents">--</p>
                </div>

                <div class="feature-card">
                    <span class="feature-icon">‚öñÔ∏è</span>
                    <h3>Governance Weight</h3>
                    <p style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="govWeight">--</p>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="section">
            <div class="cta-banner">
                <div class="cta-banner-content">
                    <h3>Manage Your Tokens</h3>
                    <p>Burn TALLY to earn TRUST and unlock features, or participate in governance</p>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <a href="/writings.html" class="cta-button">Unlock Content</a>
                        <a href="/governance.html" class="cta-button">View Governance</a>
                        <a href="https://basescan.org/token/0x1dCCFAfAe8115A299CdB3Aa21abf4Ba471eC71BA" target="_blank" class="cta-button">View TALLY on BaseScan</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contract Addresses -->
        <div class="content-card">
            <h3 style="margin-bottom: 1rem;">Contract Addresses (Base Network)</h3>
            <div style="font-size: 0.875rem; color: var(--text); line-height: 2;">
                <p><strong>TALLY Token:</strong> <code style="background: var(--light); padding: 0.25rem 0.5rem; border-radius: 4px;">0x1dCCFAfAe8115A299CdB3Aa21abf4Ba471eC71BA</code></p>
                <p><strong>TRUST Token:</strong> <code style="background: var(--light); padding: 0.25rem 0.5rem; border-radius: 4px;">0xDb7CDd209C7f5dC007e887336c6d5544a7A21280</code></p>
                <p><strong>Reserve Vault:</strong> <code style="background: var(--light); padding: 0.25rem 0.5rem; border-radius: 4px;">0x0Ff351f09f47095d4C942Ef58F8A5198C65A3b4c</code></p>
                <p><strong>Price Oracle:</strong> <code style="background: var(--light); padding: 0.25rem 0.5rem; border-radius: 4px;">0x664f08541d3A50125e75a4D33FEE203DA49c5BEB</code></p>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script>
        // Contract addresses on Base
        const CONTRACTS = {
            TALLY: '0x1dCCFAfAe8115A299CdB3Aa21abf4Ba471eC71BA',
            TRUST: '0xDb7CDd209C7f5dC007e887336c6d5544a7A21280',
            VAULT: '0x0Ff351f09f47095d4C942Ef58F8A5198C65A3b4c',
            ORACLE: '0x664f08541d3A50125e75a4D33FEE203DA49c5BEB'
        };

        const BASE_CHAIN_ID = 8453;
        const RESERVE_VALUE_USD = 620.08;

        let provider, signer, userAddress;
        let tallyContract, trustContract;

        // Minimal ABIs
        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function totalSupply() view returns (uint256)",
            "function decimals() view returns (uint8)"
        ];

        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    alert('Please install MetaMask or another Web3 wallet');
                    return;
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // Check if on Base network
                const network = await provider.getNetwork();
                if (network.chainId !== BASE_CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + BASE_CHAIN_ID.toString(16) }],
                        });
                    } catch (switchError) {
                        alert('Please switch to Base network in your wallet');
                        return;
                    }
                }

                // Initialize contracts
                tallyContract = new ethers.Contract(CONTRACTS.TALLY, ERC20_ABI, provider);
                trustContract = new ethers.Contract(CONTRACTS.TRUST, ERC20_ABI, provider);

                updateUI();
                loadBalances();
                loadGlobalStats();

                document.getElementById('connectionStatus').textContent =
                    `Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                document.getElementById('connectWalletBtn').textContent = 'Connected';
                document.getElementById('connectWalletBtn').disabled = true;

            } catch (error) {
                console.error('Error connecting wallet:', error);
                alert('Failed to connect wallet: ' + error.message);
            }
        }

        async function loadBalances() {
            if (!userAddress) return;

            try {
                // Load TALLY balance
                const tallyBalance = await tallyContract.balanceOf(userAddress);
                document.getElementById('tallyBalance').textContent =
                    parseFloat(ethers.utils.formatEther(tallyBalance)).toFixed(2);

                // Load TRUST balance
                const trustBalance = await trustContract.balanceOf(userAddress);
                document.getElementById('trustBalance').textContent =
                    parseFloat(ethers.utils.formatEther(trustBalance)).toFixed(2);

                // Covenant status (placeholder - would need actual Governance contract)
                document.getElementById('covenantStatus').textContent = 'Check Governance';

            } catch (error) {
                console.error('Error loading balances:', error);
            }
        }

        async function loadGlobalStats() {
            try {
                // Load total supply and calculate burns
                const tallyTotalSupply = await tallyContract.totalSupply();
                const trustTotalSupply = await trustContract.totalSupply();

                // Assuming initial mint was 620.08 TALLY from reserve
                const initialMint = ethers.utils.parseEther(RESERVE_VALUE_USD.toString());
                const totalBurned = initialMint.sub(tallyTotalSupply);
                const totalTrustMinted = trustTotalSupply;

                document.getElementById('totalBurned').textContent =
                    parseFloat(ethers.utils.formatEther(totalBurned)).toFixed(2);
                document.getElementById('totalTrustMinted').textContent =
                    parseFloat(ethers.utils.formatEther(totalTrustMinted)).toFixed(2);

                // Calculate progress towards unlock goal (1000 TALLY burned)
                const unlockGoal = 1000;
                const burnedForUnlocks = parseFloat(ethers.utils.formatEther(totalBurned));
                const progress = Math.min((burnedForUnlocks / unlockGoal) * 100, 100);
                document.getElementById('globalUnlockProgress').style.width = progress + '%';

                // Placeholder stats (would need actual Governance contract)
                document.getElementById('totalAdopters').textContent = '2';
                document.getElementById('unlockEvents').textContent = Math.floor(burnedForUnlocks / 10);
                document.getElementById('govWeight').textContent = '1x';

            } catch (error) {
                console.error('Error loading global stats:', error);
            }
        }

        function updateUI() {
            // Additional UI updates as needed
        }

        // Event listeners
        document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);

        // Load header and footer
        fetch('header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-placeholder').innerHTML = data;
            });

        fetch('footer.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('footer-placeholder').innerHTML = data;
            });

        // Auto-connect if already connected
        if (window.ethereum && window.ethereum.selectedAddress) {
            connectWallet();
        }
    </script>
</body>
</html>
