name: Automated Testing

on:
  push:
    branches: [main, development/v2.1, development/*]
  pull_request:
    branches: [main, development/v2.1]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify module imports
        run: |
          node -e "
            console.log('Verifying all API handler modules...');
            const modules = [
              './public/api-handlers/credentials.js',
              './public/api-handlers/api-keys.js',
              './public/api-handlers/ssh-keys.js',
              './public/api-handlers/bible-wallets.js',
              './public/api-handlers/usdt-donations.js',
              './public/api-handlers/partner-governance.js'
            ];
            modules.forEach(module => {
              try {
                require(module);
                console.log('✓', module);
              } catch (e) {
                console.error('✗', module, ':', e.message);
                process.exit(1);
              }
            });
            console.log('✓ All modules loaded successfully');
          "

      - name: Validate environment schema
        run: node scripts/validate-env.js
        env:
          # Dummy values for validation
          GENESIS_PRIVATE_KEY: "0x0000000000000000000000000000000000000000000000000000000000000000"
          AGENT_PRIVATE_KEY: "0x0000000000000000000000000000000000000000000000000000000000000000"
          INFURA_API_KEY: "test_key"
          ETHERSCAN_API_KEY: "test_key"

      - name: Lint Solidity contracts
        run: |
          npm install --save-dev solhint
          npx solhint 'contracts/**/*.sol' || true

      - name: Compile smart contracts
        run: npx hardhat compile

      - name: Run Hardhat tests
        run: npm test
        continue-on-error: true

      - name: Check for breaking changes in API
        run: |
          echo "Checking for known breaking changes..."

          # Check if credentials endpoint changed from GET to POST
          if grep -q "app.post('/api/credentials" server.js; then
            echo "✓ Credentials API properly updated to POST"
          else
            echo "⚠ Warning: Check /api/credentials endpoint configuration"
          fi

          # Check if web3-auth middleware exists
          if [ -f "public/middleware/web3-auth.js" ]; then
            echo "✓ Web3 auth middleware found"
          else
            echo "✗ Error: web3-auth.js missing"
            exit 1
          fi

          # Check if wallet identities config exists
          if [ -f "config/walletIdentities.js" ]; then
            echo "✓ Wallet identities config found"
          else
            echo "✗ Error: config/walletIdentities.js missing"
            exit 1
          fi

      - name: Check package.json and VERSION.md sync
        run: |
          NODE_VER=$(node -e "console.log(require('./package.json').version)")
          DOCS_VER=$(grep "^# Convergence Protocol v" VERSION.md | sed 's/.*v//' | cut -d' ' -f1 || echo "unknown")
          echo "package.json version: $NODE_VER"
          echo "VERSION.md version: $DOCS_VER"

          # Version sync check (warning only for now)
          if [ "$NODE_VER" != "$DOCS_VER" ] && [ "$DOCS_VER" != "unknown" ]; then
            echo "⚠ Warning: Version mismatch between package.json and VERSION.md"
            echo "  - package.json: $NODE_VER"
            echo "  - VERSION.md: $DOCS_VER"
          fi

  security-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for potential hardcoded secrets..."

          # Check for common secret patterns
          if grep -r "PRIVATE_KEY.*=" --include="*.js" --include="*.json" . \
            | grep -v "node_modules" \
            | grep -v ".git" \
            | grep -v "scripts/utils" \
            | grep -v ".env.template" \
            | grep "0x[a-f0-9]{64}"; then
            echo "⚠ Warning: Potential hardcoded private keys detected"
          else
            echo "✓ No obvious hardcoded private keys found"
          fi

      - name: Check npm vulnerabilities
        run: npm audit --production || echo "Note: Some vulnerabilities found. See details above."

      - name: Verify .env.template (not .env)
        run: |
          if [ -f ".env" ] && grep -q "PRIVATE_KEY" .env; then
            echo "✗ Error: .env file appears to contain secrets. This should not be committed."
            exit 1
          else
            echo "✓ No .env file with secrets found (good)"
          fi

          if [ -f ".env.template" ]; then
            echo "✓ .env.template exists for documentation"
          else
            echo "⚠ Warning: .env.template not found"
          fi

  integration-test:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Test Web3 auth middleware
        run: |
          node -e "
            const { verifySignature, isGenesisHuman, isAgent, isAdmin } = require('./public/middleware/web3-auth.js');

            // Test that functions exist and are callable
            console.log('Testing Web3 auth functions...');

            // Test Genesis Human check
            const genesis = '0xdc20d621a88cb8908E8E7042431C55F0E9DAc6FB';
            console.log('Genesis check:', isGenesisHuman(genesis) ? '✓' : '✗');

            // Test Agent check
            const agent = '0x6628227C195DAd7F7a8fD4F3D2cA3545A0D9CD22';
            console.log('Agent check:', isAgent(agent) ? '✓' : '✗');

            // Test admin check
            console.log('Admin check:', isAdmin(genesis) ? '✓' : '✗');

            console.log('✓ Web3 auth middleware working correctly');
          "

      - name: Test wallet identities config
        run: |
          node -e "
            const { getIdentity, canDownloadSSHKey, hasAdminAccess } = require('./config/walletIdentities.js');

            console.log('Testing wallet identities config...');

            const genesis = '0xdc20d621a88cb8908E8E7042431C55F0E9DAc6FB';
            const identity = getIdentity(genesis);

            if (identity) {
              console.log('✓ Genesis identity found:', identity.displayName);
              console.log('✓ Admin access:', hasAdminAccess(genesis) ? 'yes' : 'no');
              console.log('✓ SSH key download:', canDownloadSSHKey(genesis) ? 'yes' : 'no');
            } else {
              console.log('✗ Genesis identity not found');
              process.exit(1);
            }

            console.log('✓ Wallet identities config working correctly');
          "

      - name: Test partner governance data structure
        run: |
          node -e "
            const fs = require('fs');
            const partnerGov = JSON.parse(fs.readFileSync('./data/partner-governance.json', 'utf8'));

            console.log('Testing partner governance structure...');

            const required = ['partnerSeed', 'seedCreatedAt', 'seedGeneratedBy', 'maxPartners', 'currentPartners'];
            let valid = true;

            required.forEach(field => {
              if (partnerGov.hasOwnProperty(field)) {
                console.log('✓', field);
              } else {
                console.log('✗', field, 'missing');
                valid = false;
              }
            });

            if (valid) {
              console.log('✓ Partner governance data structure valid');
            } else {
              process.exit(1);
            }
          "

  documentation-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check MIGRATION_GUIDE exists
        run: |
          if [ -f "MIGRATION_GUIDE.md" ]; then
            echo "✓ MIGRATION_GUIDE.md found"
            # Check for key sections
            if grep -q "CRITICAL BREAKING CHANGES" MIGRATION_GUIDE.md; then
              echo "✓ MIGRATION_GUIDE.md contains breaking changes documentation"
            else
              echo "⚠ Warning: MIGRATION_GUIDE.md may be incomplete"
            fi
          else
            echo "⚠ Warning: MIGRATION_GUIDE.md not found"
          fi

      - name: Check DEPLOYMENT_CHECKLIST
        run: |
          if [ -f "DEPLOYMENT_CHECKLIST.md" ] || [ -f "DEPLOYMENT_GUIDE_V3.md" ]; then
            echo "✓ Deployment documentation found"
          else
            echo "⚠ Warning: Deployment checklist not found"
          fi

      - name: Check VERSION.md
        run: |
          if [ -f "VERSION.md" ]; then
            echo "✓ VERSION.md found"
            VERSION=$(grep "^# Convergence Protocol v" VERSION.md | sed 's/.*v//' | cut -d' ' -f1)
            echo "  Current version: $VERSION"
          else
            echo "⚠ Warning: VERSION.md not found"
          fi
